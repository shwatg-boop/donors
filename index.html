<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NYFN • Blood Donor Connect (CSV-linked)</title>
  <style>
    :root{--nyfn:#e11d48;--ink:#0f172a;--muted:#64748b;--bg:#f8fafc;--card:#ffffff;--ok:#16a34a;--warn:#b45309}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;line-height:1.35;background:var(--bg);color:var(--ink)}
    header{background:var(--card);border-bottom:1px solid #e2e8f0;position:sticky;top:0;z-index:10}
    .wrap{max-width:1080px;margin:auto;padding:16px}
    h1{margin:0;font-size:20px;display:flex;gap:10px;align-items:center}
    .badge{background:var(--nyfn);color:#fff;padding:2px 8px;border-radius:999px;font-size:12px;letter-spacing:.3px}
    .grid{display:grid;gap:12px}
    @media(min-width:760px){.grid.cols-3{grid-template-columns:1fr 1fr 1fr}}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:14px;padding:14px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input,button{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;background:#fff}
    select:focus,input:focus,button:focus{outline:3px solid rgba(225,29,72,.2);border-color:var(--nyfn)}
    button{cursor:pointer;background:var(--nyfn);color:#fff;border-color:var(--nyfn)}
    .muted{color:var(--muted)}.ok{color:var(--ok)}.warn{color:var(--warn)}
    .stack{display:flex;gap:10px;flex-wrap:wrap}.stack>*{flex:1 1 180px}
    table{width:100%;border-collapse:collapse;font-size:14px}th,td{padding:10px;border-bottom:1px solid #e2e8f0;text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #e2e8f0;background:#fff;font-size:12px}
    .footer{color:var(--muted);font-size:12px;margin-top:18px}
    details.debug{margin-top:12px}
    details.debug pre{background:#0b1020;color:#e5e7eb;padding:10px;border-radius:10px;overflow:auto;max-height:220px}
  </style>
  <!-- CSV parser for robust quoted/commas handling -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
</head>
<body>
<header><div class="wrap"><h1><span class="badge">NYFN</span> Blood Donor Connect <span class="muted" style="font-weight:500">— CSV-linked</span></h1></div></header>

<main class="wrap" style="padding-block:18px">
  <section class="grid cols-3">
    <div class="card"><label for="province">Province</label><select id="province"></select></div>
    <div class="card"><label for="district">District</label><select id="district"></select></div>
    <div class="card"><label for="municipality">Municipality</label><select id="municipality"></select></div>
  </section>

  <section class="grid cols-3" style="margin-top:12px">
    <div class="card"><label for="blood">Blood group</label>
      <select id="blood">
        <option value="">Any</option>
        <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
        <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
      </select>
    </div>
    <div class="card"><label>&nbsp;</label><button id="btnShow">Show donors</button></div>
    <div class="card"><label>&nbsp;</label><div class="pill" id="summaryPill">Booting…</div></div>
  </section>

  <section class="card" style="margin-top:12px">
    <div class="stack">
      <div class="pill"><strong>Municipality authority</strong> <span id="authorityLabel" class="muted">— not set</span></div>
      <div class="pill"><strong>Hotline</strong> <a id="authorityPhone" class="inline" href="#">—</a></div>
    </div>
    <div class="footer">If no donor responds, call the authority for the selected municipality.</div>
  </section>

  <section class="card" style="margin-top:12px">
    <h3 style="margin:0 0 8px 0">Matching donors</h3>
    <table id="donorsTable">
      <thead><tr><th>Name</th><th>Phone</th><th>Blood</th><th>Municipality</th><th>District</th></tr></thead>
      <tbody id="donorsBody"><tr><td colspan="5" class="muted">Select a location and click <em>Show donors</em>.</td></tr></tbody>
    </table>
  </section>

  <section class="card" style="margin-top:12px">
    <details open><summary><strong>Admin</strong> — add a single donor</summary>
      <p class="footer">Only the admin key is required to add a donor. Regular users do not need it.</p>
      <div class="grid cols-3" style="margin-top:10px">
        <div><label for="adminPass">Admin key</label><input id="adminPass" type="password" placeholder="Enter admin key"/></div>
      </div>
      <div id="adminForm" style="margin-top:10px">
        <div class="grid cols-3">
          <div><label for="aProvince">Province</label><select id="aProvince"></select></div>
          <div><label for="aDistrict">District</label><select id="aDistrict"></select></div>
          <div><label for="aMunicipality">Municipality</label><select id="aMunicipality"></select></div>
        </div>
        <div class="grid cols-3" style="margin-top:10px">
          <div><label for="aName">Donor name</label><input id="aName" placeholder="Full name"/></div>
          <div><label for="aPhone">Phone (+977…)</label><input id="aPhone" placeholder="e.g. +9779801xxxxxx"/></div>
          <div><label for="aBlood">Blood group</label>
            <select id="aBlood">
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
            </select>
          </div>
        </div>
        <div class="stack" style="margin-top:10px"><button id="btnAddDonor">Add donor</button><span id="adminMsg" class="footer"></span></div>
      </div>
    </details>
  </section>

  <details class="debug"><summary>Debug</summary>
    <div class="footer" id="dbgInfo"></div>
    <pre id="dbgOut"></pre>
  </details>

  <div class="footer" id="footNote">Backend: Apps Script (GET action=list, POST action=add). API is prelinked.</div>
</main>

<script>
// === Config ===
const API_URL = "https://script.google.com/macros/s/AKfycbxS61tz3MCATzvFBP21oFm9eT5WiEumy7qV3212zCPykUWSFf9erlSRkxLQ1ubL86cBqQ/exec";
const CSV_PATH = "./province_district_municipality.csv"; // keep next to index.html

// === DOM helpers ===
const $ = (id)=>document.getElementById(id);
function fillSelect(el, values, placeholder){
  el.innerHTML='';
  if(placeholder){const o=document.createElement('option');o.value='';o.textContent=placeholder;el.appendChild(o);}
  (values||[]).forEach(v=>{const opt=document.createElement('option');opt.value=opt.textContent=v;el.appendChild(opt);});
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));}

// === Elements ===
const provinceSel=$('province'), districtSel=$('district'), municipalitySel=$('municipality'), bloodSel=$('blood');
const donorsBody=$('donorsBody'), summar
