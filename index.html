<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NYFN • Blood Donor Connect </title>
  <style>
    :root{--nyfn:#e11d48;--ink:#0f172a;--muted:#64748b;--bg:#f8fafc;--card:#ffffff;--ok:#16a34a;--warn:#b45309}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;line-height:1.35;background:var(--bg);color:var(--ink)}
    header{background:var(--card);border-bottom:1px solid #e2e8f0;position:sticky;top:0;z-index:10}
    .wrap{max-width:1080px;margin:auto;padding:16px}
    h1{margin:0;font-size:20px;display:flex;gap:10px;align-items:center}
    .badge{background:var(--nyfn);color:#fff;padding:2px 8px;border-radius:999px;font-size:12px;letter-spacing:.3px}
    .grid{display:grid;gap:12px}
    @media(min-width:760px){.grid.cols-3{grid-template-columns:1fr 1fr 1fr}}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:14px;padding:14px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input,button{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;background:#fff}
    select:focus,input:focus,button:focus{outline:3px solid rgba(225,29,72,.2);border-color:var(--nyfn)}
    button{cursor:pointer;background:var(--nyfn);color:#fff;border-color:var(--nyfn)}
    button.secondary{background:#fff;color:var(--ink);border-color:#cbd5e1}
    .muted{color:var(--muted)}.ok{color:var(--ok)}.warn{color:var(--warn)}
    .stack{display:flex;gap:10px;flex-wrap:wrap}.stack>*{flex:1 1 180px}
    table{width:100%;border-collapse:collapse;font-size:14px}th,td{padding:10px;border-bottom:1px solid #e2e8f0;text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #e2e8f0;background:#fff;font-size:12px}
    .footer{color:var(--muted);font-size:12px;margin-top:18px}
    details.debug{margin-top:12px}
    details.debug pre{background:#0b1020;color:#e5e7eb;padding:10px;border-radius:10px;overflow:auto;max-height:280px}
    .err{color:#b91c1c}
  </style>
  <!-- Robust CSV parser (handles quoted commas). -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
</head>
<body>
<header><div class="wrap"><h1><span class="badge">NYFN</span> Blood Donor Connect <span class="muted" style="font-weight:500">(Through this hotline, National Youth Federation Nepal will provide Blood Donors for medical emergencies-- in all municipalities throughout Nepal.

Please select your required blood group and search for your location from the menu below, and we will provide you with a list of donors. In case of any problems, please contact the listed authority for your area.)</span></h1></div></header>

<main class="wrap" style="padding-block:18px">
  <section class="grid cols-3">
    <div class="card"><label for="province">Province</label><select id="province"></select></div>
    <div class="card"><label for="district">District</label><select id="district"></select></div>
    <div class="card"><label for="municipality">Municipality</label><select id="municipality"></select></div>
  </section>

  <section class="grid cols-3" style="margin-top:12px">
    <div class="card"><label for="blood">Blood group</label>
      <select id="blood">
        <option value="">Any</option>
        <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
        <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
      </select>
    </div>
    <div class="card"><label>&nbsp;</label><button id="btnShow">Show donors</button></div>
    <div class="card"><label>&nbsp;</label><div class="pill" id="summaryPill">Booting…</div></div>
  </section>

  <section class="card" style="margin-top:12px">
    <div class="stack">
      <div class="pill"><strong>Municipality authority</strong> <span id="authorityLabel" class="muted">— not set</span></div>
      <div class="pill"><strong>Hotline</strong> <a id="authorityPhone" class="inline" href="#">—</a></div>
    </div>
    <div class="footer">If no donor responds, call the authority for the selected municipality.</div>
  </section>

  <section class="card" style="margin-top:12px">
    <h3 style="margin:0 0 8px 0">Matching donors</h3>
    <table id="donorsTable">
      <thead><tr><th>Name</th><th>Phone</th><th>Blood</th><th>Municipality</th><th>District</th></tr></thead>
      <tbody id="donorsBody"><tr><td colspan="5" class="muted">Select a location and click <em>Show donors</em>.</td></tr></tbody>
    </table>
  </section>

  <section class="card" style="margin-top:12px">
    <details open><summary><strong>Admin</strong> — add a single donor</summary>
      <p class="footer">Only the admin key is required to add a donor. Regular users do not need it.</p>
      <div class="grid cols-3" style="margin-top:10px">
        <div><label for="adminPass">Admin key</label><input id="adminPass" type="password" placeholder="Enter admin key"/></div>
      </div>
      <div id="adminForm" style="margin-top:10px">
        <div class="grid cols-3">
          <div><label for="aProvince">Province</label><select id="aProvince"></select></div>
          <div><label for="aDistrict">District</label><select id="aDistrict"></select></div>
          <div><label for="aMunicipality">Municipality</label><select id="aMunicipality"></select></div>
        </div>
        <div class="grid cols-3" style="margin-top:10px">
          <div><label for="aName">Donor name</label><input id="aName" placeholder="Full name"/></div>
          <div><label for="aPhone">Phone (+977…)</label><input id="aPhone" placeholder="e.g. +9779801xxxxxx"/></div>
          <div><label for="aBlood">Blood group</label>
            <select id="aBlood">
              <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
              <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
            </select>
          </div>
        </div>
        <div class="stack" style="margin-top:10px"><button id="btnAddDonor">Add donor</button><span id="adminMsg" class="footer"></span></div>
      </div>
    </details>
  </section>

  <details class="debug"><summary>Debug</summary>
    <div class="footer" id="dbgInfo"></div>
    <pre id="dbgOut"></pre>
    <div class="footer err" id="csvErr"></div>
  </details>

  <div class="footer" id="footNote">Backend: Apps Script (GET action=list → returns {"ok":true,"rows":[...]}; POST action=add). API is prelinked.</div>
</main>

<script>
// === Config ===
const API_URL = "https://script.google.com/macros/s/AKfycbxS61tz3MCATzvFBP21oFm9eT5WiEumy7qV3212zCPykUWSFf9erlSRkxLQ1ubL86cBqQ/exec";

// CSV auto-discovery (override with ?csv=path)
const DEFAULT_CSV_NAMES = [
  "province_district_municipality.csv",
  "data/province_district_municipality.csv",
  "assets/province_district_municipality.csv",
  "csv/province_district_municipality.csv"
];
function getCsvCandidates(){
  const u = new URL(location.href);
  const override = u.searchParams.get("csv");
  if(override && override.trim()) return [override.trim()];
  // Try current folder first with default name, then common folders
  return DEFAULT_CSV_NAMES.map(p=>p);
}

// === DOM helpers ===
const $ = (id)=>document.getElementById(id);
function fillSelect(el, values, placeholder){
  el.innerHTML='';
  if(placeholder){const o=document.createElement('option');o.value='';o.textContent=placeholder;el.appendChild(o);}
  (values||[]).forEach(v=>{const opt=document.createElement('option');opt.value=opt.textContent=v;el.appendChild(opt);});
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));}

// === Elements ===
const provinceSel=$('province'), districtSel=$('district'), municipalitySel=$('municipality'), bloodSel=$('blood');
const donorsBody=$('donorsBody'), summaryPill=$('summaryPill'), authorityLabel=$('authorityLabel');
const aProvince=$('aProvince'), aDistrict=$('aDistrict'), aMunicipality=$('aMunicipality');
const dbgInfo=$('dbgInfo'), dbgOut=$('dbgOut'), csvErr=$('csvErr'), adminMsg=$('adminMsg');

// === State built from CSV ===
let HIER = { provinces: [], districtsByProvince: {}, municipalitiesByDistrict: {} };

// Wait for Papa (defer script) to be ready
async function ensurePapa(){
  for(let i=0;i<80;i++){ // up to ~8s
    if (window.Papa) return;
    await new Promise(r=>setTimeout(r,100));
  }
  throw new Error("PapaParse failed to load.");
}

// Try multiple CSV paths until one succeeds
async function fetchFirstCSV(){
  const candidates = getCsvCandidates();
  const tried = [];
  for(const path of candidates){
    try{
      const res = await fetch(path, {cache:'no-store'});
      tried.push(`${path} → ${res.status}`);
      if(!res.ok) continue;
      const text = await res.text();
      return { path, text, tried };
    }catch(e){
      tried.push(`${path} → ERR`);
    }
  }
  throw new Error("CSV not found in any candidate paths.\nTried:\n" + tried.join("\n"));
}

// === Load CSV (works on GitHub Pages + any local HTTP server) ===
async function loadCSV(){
  await ensurePapa();
  let csvText, path, triedList;
  try{
    const {path: p, text, tried} = await fetchFirstCSV();
    path = p; csvText = text; triedList = tried;
  }catch(err){
    csvErr.textContent = `${err.message}\nTip: Put "province_district_municipality.csv" next to index.html, or pass ?csv=path/to/file.csv`;
    throw err;
  }

  const parsed = Papa.parse(csvText, {
    header:true, skipEmptyLines:true, delimiter:"" // auto-detect delimiter
  });
  if(parsed.errors && parsed.errors.length){
    console.warn('CSV parse warnings', parsed.errors);
  }
  const rows = (parsed.data||[]).map(r=>({
    province: String(r.province||r.Province||r.PROVINCE||'').trim(),
    district: String(r.district||r.District||r.DISTRICT||'').trim(),
    municipality: String(r.municipality||r.Municipality||r.MUNICIPALITY||'').trim(),
  })).filter(r=>r.province && r.district && r.municipality);

  if(rows.length === 0){
    csvErr.textContent = `CSV loaded from "${path}" but found 0 valid rows.\n`+
                         `Expected headers: province,district,municipality (any case).`;
  }
  // Build hierarchy preserving first-seen order
  const provinces = []; const seenP = new Set();
  const districtsByProvince = {}; const municipalitiesByDistrict = {};
  for(const r of rows){
    if(!seenP.has(r.province)){
      seenP.add(r.province); provinces.push(r.province);
      districtsByProvince[r.province] = districtsByProvince[r.province] || [];
    }
    const dlist = districtsByProvince[r.province];
    if(!dlist.includes(r.district)) dlist.push(r.district);
    const mlist = municipalitiesByDistrict[r.district] || (municipalitiesByDistrict[r.district] = []);
    if(!mlist.includes(r.municipality)) mlist.push(r.municipality);
  }
  HIER = { provinces, districtsByProvince, municipalitiesByDistrict };

  // Debug summary
  if(dbgOut){
    const counts = Object.values(districtsByProvince).map(a=>a.length).reduce((a,b)=>a+b,0);
    dbgOut.textContent =
      `CSV path: ${path}\n`+
      `Provinces: ${provinces.length}\nDistricts: ${counts}\n`+
      `Example Province: ${provinces[0]||'-'}\n`+
      `Tried:\n${(triedList||[]).join('\n')}`;
  }
}

// === Populate selectors ===
function bootSelectors(){
  fillSelect(provinceSel, HIER.provinces, 'Select province');
  fillSelect(aProvince, HIER.provinces, 'Select province');

  provinceSel.addEventListener('change', ()=>{
    const p = provinceSel.value;
    fillSelect(districtSel, HIER.districtsByProvince[p]||[], 'Select district');
    fillSelect(municipalitySel, [], 'Any (district-wide)');
  });

  districtSel.addEventListener('change', ()=>{
    const d = districtSel.value;
    const munis = HIER.municipalitiesByDistrict[d]||[];
    fillSelect(municipalitySel, munis, 'Any (district-wide)');
    municipalitySel.value = ''; // default = district-wide
  });

  municipalitySel.addEventListener('change', ()=>{
    const m = municipalitySel.value;
    authorityLabel.textContent = m ? (m + ' authority') : '— not set';
  });

  // Admin mirrors (no "Any" for admin)
  aProvince.addEventListener('change', ()=>{
    const p=aProvince.value; fillSelect(aDistrict, HIER.districtsByProvince[p]||[], 'Select district'); aDistrict.dispatchEvent(new Event('change'));
  });
  aDistrict.addEventListener('change', ()=>{
    const d=aDistrict.value; fillSelect(aMunicipality, HIER.municipalitiesByDistrict[d]||[], 'Select municipality');
  });

  // Preselect first entries; municipality stays “Any”
  if(HIER.provinces.length){
    provinceSel.value = HIER.provinces[0]; provinceSel.dispatchEvent(new Event('change'));
    const fd = (HIER.districtsByProvince[provinceSel.value]||[])[0];
    if(fd){ districtSel.value = fd; districtSel.dispatchEvent(new Event('change')); }
    aProvince.value = provinceSel.value; aProvince.dispatchEvent(new Event('change'));
    aDistrict.value = districtSel.value; aDistrict.dispatchEvent(new Event('change'));
  }
}

// === Response normalization ===
function _normalizeRows(json){
  if(Array.isArray(json)) return json;
  if(json && Array.isArray(json.rows))   return json.rows;    // your script shape
  if(json && Array.isArray(json.donors)) return json.donors;
  if(json && Array.isArray(json.data))   return json.data;
  // last resort: {0:{},1:{}} → array
  if(json && typeof json==='object'){
    const vals = Object.values(json);
    if(vals.length && vals.every(v => v && typeof v==='object' && !Array.isArray(v))) return vals;
  }
  return [];
}
function _mapRow(r, fb){
  const o=(r&&typeof r==='object')?r:{};
  const phone = String(o.phone ?? o.Phone ?? o.PHONE ?? o.phone_number ?? o.contact ?? '');
  const blood = String(o.blood ?? o.Blood ?? o.BLOOD ?? o.blood_group ?? '');
  return {
    name:         String(o.name ?? o.Name ?? o.NAME ?? ''),
    phone,
    blood,
    municipality: String(o.municipality ?? o.Municipality ?? o.MUNICIPALITY ?? (fb.municipality || '')),
    district:     String(o.district ?? o.District     ?? o.DISTRICT     ?? (fb.district || ''))
  };
}

// === API calls ===
// Match your tester: send district (and municipality if chosen). No province in list.
async function listDonorsAPI(district, municipality, blood){
  const D=(district||'').trim(), M=(municipality||'').trim(), B=(blood||'').trim();
  const params = new URLSearchParams({ action:'list' });
  if(D) params.append('district', D);
  if(M) params.append('municipality', M);
  if(B) params.append('blood', B);

  const url = `${API_URL}?${params.toString()}`;
  let res, txt, json=null;
  try{
    res = await fetch(url, { method:'GET', cache:'no-store' });
    txt = await res.text();
  }catch{
    return [];
  }
  if(dbgInfo){ dbgInfo.textContent = `GET ${url} — ${res ? res.status : 'ERR'} (${(txt||'').length} bytes)`; }
  if(dbgOut){ dbgOut.textContent = (txt||'').slice(0,5000); }

  if(!res || !res.ok) return [];
  try{ json = JSON.parse(txt); }catch{}
  const rows = _normalizeRows(json);
  return rows.map(r => _mapRow(r, {district:D, municipality:M}));
}

async function addDonorAPI(payload, adminKey){
  if(!adminKey) throw new Error('Admin key required.');
  const body = new URLSearchParams({
    action:'add', admin_key:adminKey,
    province:payload.province, district:payload.district, municipality:payload.municipality,
    name:payload.name, phone:payload.phone, blood:payload.blood
  });
  const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
  const txt = await res.text(); let json=null; try{ json = JSON.parse(txt); }catch{}
  const ok = json && (json.ok===true || json.ok===1 || json.ok==='true' || json.status==='ok');
  if(!ok) throw new Error(json ? (json.error||json.message||'Add failed') : txt);
  return true;
}

// === Render ===
function renderDonors(){
  const d=districtSel.value, m=municipalitySel.value, bg=bloodSel.value;
  if(!d){
    donorsBody.innerHTML = '<tr><td colspan="5" class="muted">Select a district first.</td></tr>';
    summaryPill.textContent = 'Ready';
    return;
  }
  donorsBody.innerHTML = '<tr><td colspan="5" class="muted">Loading…</td></tr>';
  listDonorsAPI(d,m,bg).then(rows=>{
    if(!Array.isArray(rows)) rows=[];
    const muniLabel = m || 'any municipality';
    if(rows.length===0){
      donorsBody.innerHTML = `<tr><td colspan="5" class="warn">No donors found for ${muniLabel}, ${d}.</td></tr>`;
    }else{
      donorsBody.innerHTML = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.name||'')}</td>
          <td><a href="tel:${escapeHtml(r.phone||'')}">${escapeHtml(r.phone||'')}</a></td>
          <td>${escapeHtml(r.blood||'')}</td>
          <td>${escapeHtml(r.municipality||'')}</td>
          <td>${escapeHtml(r.district||'')}</td>
        </tr>`).join('');
    }
    summaryPill.textContent = rows.length + ' match' + (rows.length===1?'':'es');
  }).catch(()=>{
    donorsBody.innerHTML = '<tr><td colspan="5" class="warn">No donors found.</td></tr>';
    summaryPill.textContent = '—';
  });
}

// === Admin ===
$('btnAddDonor').addEventListener('click', async ()=>{
  const key = $('adminPass').value.trim(); if(!key){ adminMsg.textContent='Enter admin key.'; return; }
  const p=aProvince.value, d=aDistrict.value, m=aMunicipality.value;
  const name=$('aName').value.trim(); const phone=$('aPhone').value.trim(); const blood=$('aBlood').value;
  if(!p||!d||!m||!name||!phone){ adminMsg.textContent='Please complete all fields.'; return; }
  adminMsg.textContent='Saving…';
  try{
    await addDonorAPI({province:p,district:d,municipality:m,name,phone,blood}, key);
    $('aName').value=''; $('aPhone').value='';
    adminMsg.textContent=`Donor added to ${m}, ${d}.`;
    if(districtSel.value===d && (municipalitySel.value===m || municipalitySel.value==='')) renderDonors();
  }catch(err){
    adminMsg.textContent = 'Error: ' + (err.message||String(err));
  }
});

// === Boot ===
(async function init(){
  try{
    summaryPill.textContent = 'Loading map…';
    await loadCSV();   // builds HIER or shows csvErr with exact reason
    bootSelectors();   // populates dropdowns
    summaryPill.textContent = 'Ready';
  }catch(err){
    console.error(err);
    summaryPill.textContent = 'Map failed to load';
    if(location.protocol === 'file:'){
      csvErr.textContent = (csvErr.textContent ? csvErr.textContent + ' ' : '')
        + 'Open via a local server (e.g., python -m http.server) or GitHub Pages; file:// cannot fetch CSV.';
    }
  }
})();
$('btnShow').addEventListener('click', renderDonors);
</script>
</body>
</html>
